<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Provider Data Collection Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .map-container { height: 350px; }
        @media (min-width: 768px) { .map-container { height: 400px; } }
        @media (min-width: 1024px) { .map-container { height: 450px; } }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .fade-out { animation: fadeOut 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }
        .glass { -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .progress-bar { width: 0%; transition: width 0.3s ease; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        
        /* Mobile optimizations */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        input, select, button { font-size: 16px; } /* Prevents zoom on iOS */
        
        /* Enhanced mobile responsiveness */
        @media (max-width: 640px) {
            .container { padding-left: 0.75rem; padding-right: 0.75rem; }
            .card-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
            .modal-content { width: 95%; max-width: 95%; max-height: 90vh; overflow-y: auto; padding: 1rem; }
            .btn-sm-full { width: 100%; margin-bottom: 0.5rem; justify-content: center; }
            .hide-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
            .hide-scrollbar::-webkit-scrollbar { display: none; }
            .sm-stack { display: flex; flex-direction: column; }
            .sm-stack > * { margin-bottom: 0.5rem; width: 100%; }
            
            /* Table improvements for mobile */
            table { border-collapse: separate; border-spacing: 0; }
            table th, table td { padding: 8px; }
            .table-responsive { margin: 0 -8px; width: calc(100% + 16px); }
            .table-compact td { padding-top: 6px; padding-bottom: 6px; }
            .mobile-info { display: block; margin-top: 2px; }
            
            /* Mobile card view styling */
            .mobile-card-view { display: block !important; }
            .mobile-card-view thead { display: none; }
            .mobile-card-view tbody, .mobile-card-view tr { display: block; width: 100%; }
            .mobile-card-view tr { 
                margin-bottom: 1rem; 
                border-radius: 0.5rem; 
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); 
                overflow: hidden; 
                border: 1px solid #e5e7eb;
                background-color: white;
            }
            .mobile-card-view td { 
                display: block; 
                width: auto; 
                text-align: left; 
                padding: 0.75rem;
                position: relative;
            }
            .mobile-card-view td:not(:first-child) { border-top: 1px solid #f3f4f6; }
            .mobile-card-view td:before { 
                content: attr(data-label); 
                font-weight: 600; 
                margin-right: 0.5rem;
                color: #4b5563;
                display: block;
                font-size: 0.75rem;
                text-transform: uppercase;
            }
            .mobile-card-view td:nth-child(1) { display: none; } /* Hide checkbox column */
            .mobile-card-view td:nth-child(2):before { display: none; } /* Hide "Name" label for first row for cleaner look */
            .mobile-card-view td:nth-child(2) { 
                background: #f9fafb; 
                border-bottom: 2px solid #e5e7eb;
                padding-bottom: 0.5rem;
            }
            .mobile-card-view td:last-child { 
                border-top: none; 
                padding-top: 0.5rem; 
                background: #f9fafb;
                text-align: right;
            }
            
            /* Font size adjustments */
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.25rem; }
            h3 { font-size: 1.125rem; }
            
            /* Spacing adjustments */
            .section { margin-bottom: 1.5rem; }
            .card { padding: 0.75rem; }
        }
        
        /* Custom toggle for mobile */
        @media (max-width: 640px) {
            .toggle {
                transform: scale(0.8);
            }
        }
        
        /* Touch-friendly tap targets */
        @media (max-width: 768px) {
            button, .btn, select, input[type="checkbox"], input[type="radio"] {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-3 sm:px-4 py-3 sm:py-4">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <div class="flex items-center space-x-2 sm:space-x-3 mb-3 sm:mb-0">
                    <i class="fas fa-database text-xl sm:text-2xl"></i>
                    <h1 class="text-lg sm:text-xl md:text-2xl font-bold">Service Provider Database</h1>
                </div>
                <div class="flex flex-row items-center space-x-2 sm:space-x-4 w-full sm:w-auto">
                    <div class="glass rounded-lg px-2 sm:px-3 py-1 text-sm flex-grow sm:flex-grow-0">
                        <i class="fas fa-user-circle mr-1 sm:mr-2"></i>
                        <span id="userRole" class="hidden sm:inline">{{ session.user_name if session.user_name else 'User' }} ({{ session.user_role.title() if session.user_role else 'Viewer' }})</span>
                        <span class="sm:hidden">{{ session.user_role.title() if session.user_role else 'Viewer' }}</span>
                    </div>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-3 sm:px-4 py-1 sm:py-2 rounded-lg transition text-sm">
                        <i class="fas fa-sign-out-alt sm:mr-2"></i><span class="hidden sm:inline">Logout</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm border-b overflow-x-auto">
        <div class="container mx-auto px-3 sm:px-4">
            <!-- Mobile dropdown for small screens -->
            <div class="block md:hidden py-2">
                <select id="mobileTabSelector" aria-label="Select tab" title="Select tab to navigate" class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <option value="dashboard">Dashboard</option>
                    <option value="search">Search & Filter</option>
                    <option value="map">Map</option>
                    <option value="collection">Data Collection</option>
                </select>
            </div>
            <!-- Regular tabs for larger screens -->
            <div class="hidden md:flex md:space-x-2 lg:space-x-6 whitespace-nowrap text-sm lg:text-base">
                <button class="tab-btn active py-3 px-2 border-b-2 border-blue-500 text-blue-600 font-medium transition-colors" data-tab="dashboard">
                    <i class="fas fa-chart-bar mr-1 lg:mr-2"></i><span>Dashboard</span>
                </button>
                <button class="tab-btn py-3 px-2 border-b-2 border-transparent hover:text-blue-600 font-medium transition-colors" data-tab="search">
                    <i class="fas fa-search mr-1 lg:mr-2"></i><span>Search</span>
                </button>
                <button class="tab-btn py-3 px-2 border-b-2 border-transparent hover:text-blue-600 font-medium transition-colors" data-tab="map">
                    <i class="fas fa-map-marked-alt mr-1 lg:mr-2"></i><span>Map</span>
                </button>
                <button class="tab-btn py-3 px-2 border-b-2 border-transparent hover:text-blue-600 font-medium transition-colors" data-tab="collection">
                    <i class="fas fa-cloud-download-alt mr-1 lg:mr-2"></i><span>Data Collection</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6 md:py-8">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content fade-in">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
                <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-xs sm:text-sm font-medium">Total Providers</p>
                            <p class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900" data-stat="total-providers">Loading...</p>
                        </div>
                        <i class="fas fa-users text-blue-500 text-xl md:text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-xs sm:text-sm font-medium">Individuals</p>
                            <p class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900" data-stat="individuals">Loading...</p>
                        </div>
                        <i class="fas fa-user text-green-500 text-xl md:text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-4 sm:p-6 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-xs sm:text-sm font-medium">Business Owners</p>
                            <p class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900" data-stat="businesses">Loading...</p>
                        </div>
                        <i class="fas fa-briefcase text-purple-500 text-2xl"></i>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">States Covered</p>
                            <p class="text-3xl font-bold text-gray-900" data-stat="states">Loading...</p>
                        </div>
                        <i class="fas fa-map-marker-alt text-orange-500 text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Providers by Category</h3>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Geographic Distribution</h3>
                    <canvas id="stateChart"></canvas>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Data Collection Activity</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Source</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Category</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Records</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Time</th>
                            </tr>
                        </thead>
                        <tbody id="activityTable">
                            <tr class="border-t">
                                <td class="px-4 py-3">Yelp API</td>
                                <td class="px-4 py-3">Residential Cleaning</td>
                                <td class="px-4 py-3">247</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Success</span></td>
                                <td class="px-4 py-3">2 mins ago</td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-4 py-3">Google Maps</td>
                                <td class="px-4 py-3">HVAC</td>
                                <td class="px-4 py-3">156</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Success</span></td>
                                <td class="px-4 py-3">5 mins ago</td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-4 py-3">LinkedIn</td>
                                <td class="px-4 py-3">Electricians</td>
                                <td class="px-4 py-3">89</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">Processing</span></td>
                                <td class="px-4 py-3">8 mins ago</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Search & Filter Tab -->
        <div id="search" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Search & Filter Providers</h3>
                
                <!-- Search Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <select id="categoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" title="Filter by service category">
                            <option value="">All Categories</option>
                            <option value="residential-cleaning">Residential Cleaning</option>
                            <option value="commercial-janitorial">Commercial Janitorial</option>
                            <option value="carpet-cleaning">Carpet Cleaning</option>
                            <option value="window-cleaning">Window Cleaning</option>
                            <option value="painters">Painters</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="hvac">HVAC</option>
                            <option value="plumbers">Plumbers</option>
                            <option value="electricians">Electricians</option>
                            <option value="floor-care">Floor Care</option>
                            <option value="waste-management">Waste Management</option>
                            <option value="pest-control">Pest Control</option>
                            <option value="landscaping">Landscaping</option>
                            <option value="pressure-washing">Pressure Washing</option>
                            <option value="tub-tile">Tub & Tile</option>
                            <option value="construction-cleanup">Construction Cleanup</option>
                            <option value="covid-spray">COVID/Bacterial Spray</option>
                            <option value="car-detailing">Car Detailing</option>
                            <option value="specialty">Specialty Services</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                        <select id="stateFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" title="Filter by state">
                            <option value="">All States</option>
                            <option value="AL">Alabama</option>
                            <option value="AK">Alaska</option>
                            <option value="AZ">Arizona</option>
                            <option value="AR">Arkansas</option>
                            <option value="CA">California</option>
                            <option value="CO">Colorado</option>
                            <option value="CT">Connecticut</option>
                            <option value="DE">Delaware</option>
                            <option value="FL">Florida</option>
                            <option value="GA">Georgia</option>
                            <option value="HI">Hawaii</option>
                            <option value="ID">Idaho</option>
                            <option value="IL">Illinois</option>
                            <option value="IN">Indiana</option>
                            <option value="IA">Iowa</option>
                            <option value="KS">Kansas</option>
                            <option value="KY">Kentucky</option>
                            <option value="LA">Louisiana</option>
                            <option value="ME">Maine</option>
                            <option value="MD">Maryland</option>
                            <option value="MA">Massachusetts</option>
                            <option value="MI">Michigan</option>
                            <option value="MN">Minnesota</option>
                            <option value="MS">Mississippi</option>
                            <option value="MO">Missouri</option>
                            <option value="MT">Montana</option>
                            <option value="NE">Nebraska</option>
                            <option value="NV">Nevada</option>
                            <option value="NH">New Hampshire</option>
                            <option value="NJ">New Jersey</option>
                            <option value="NM">New Mexico</option>
                            <option value="NY">New York</option>
                            <option value="NC">North Carolina</option>
                            <option value="ND">North Dakota</option>
                            <option value="OH">Ohio</option>
                            <option value="OK">Oklahoma</option>
                            <option value="OR">Oregon</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="RI">Rhode Island</option>
                            <option value="SC">South Carolina</option>
                            <option value="SD">South Dakota</option>
                            <option value="TN">Tennessee</option>
                            <option value="TX">Texas</option>
                            <option value="UT">Utah</option>
                            <option value="VT">Vermont</option>
                            <option value="VA">Virginia</option>
                            <option value="WA">Washington</option>
                            <option value="WV">West Virginia</option>
                            <option value="WI">Wisconsin</option>
                            <option value="WY">Wyoming</option>
                            <option value="DC">District of Columbia</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Provider Type</label>
                        <select id="typeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" title="Filter by provider type">
                            <option value="">All Types</option>
                            <option value="individual">Individual</option>
                            <option value="business">Business Owner</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Zipcode Prefix</label>
                        <select id="confidenceFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" title="Filter by zipcode prefix">
                            <option value="">All Zipcodes</option>
                            <option value="high">High (>80%)</option>
                            <option value="medium">Medium (60-80%)</option>
                            <option value="low">Low (<60%)</option>
                        </select>
                    </div>
                </div>

                <!-- Search Bar -->
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mb-6">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="Search by name, email, phone, or city..." 
                               class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex gap-2 sm:gap-4">
                        <button id="searchBtn" class="flex-1 sm:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 sm:px-6 py-2 rounded-lg transition">
                            <i class="fas fa-search sm:mr-2"></i><span class="hidden sm:inline">Search</span>
                        </button>
                        <button id="clearBtn" class="flex-1 sm:flex-none bg-gray-500 hover:bg-gray-600 text-white px-4 sm:px-6 py-2 rounded-lg transition">
                            <i class="fas fa-times sm:mr-2"></i><span class="hidden sm:inline">Clear</span>
                        </button>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div class="flex items-center flex-wrap gap-2 sm:gap-4">
                        <span class="text-sm text-gray-600 mr-1">Export:</span>
                        <button id="exportCsv" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm transition">
                            <i class="fas fa-file-csv sm:mr-2"></i><span class="hidden sm:inline">CSV</span>
                        </button>
                        <button id="exportExcel" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-sm transition">
                            <i class="fas fa-file-excel sm:mr-2"></i><span class="hidden sm:inline">Excel</span>
                        </button>
                    </div>
                    <div class="w-full sm:w-auto">
                        <button id="deduplicateBtn" class="w-full sm:w-auto bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm transition">
                            <i class="fas fa-magic mr-1"></i>Remove Duplicates
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">
                        <span id="resultCount">Showing 1,247 results</span>
                    </div>
                </div>
            </div>

            <!-- Search Results -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="overflow-x-auto hide-scrollbar table-responsive">
                    <table class="w-full text-sm table-auto min-w-full divide-y divide-gray-200 search-results-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">
                                    <label for="selectAll" class="sr-only">Select All</label>
                                    <input type="checkbox" id="selectAll" class="rounded" title="Select all providers" aria-label="Select all providers">
                                </th>
                                <th class="px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">Name</th>
                                <th class="hidden sm:table-cell px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">Email</th>
                                <th class="hidden md:table-cell px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">Phone</th>
                                <th class="hidden sm:table-cell px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">Location</th>
                                <th class="hidden lg:table-cell px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">Type</th>
                                <th class="hidden md:table-cell px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">Category</th>
                                <th class="hidden xl:table-cell px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">Source</th>
                                <th class="hidden lg:table-cell px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">Zipcode</th>
                                <th class="px-2 sm:px-4 py-2 sm:py-3 text-left font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="searchResults">
                            <!-- Results will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="px-6 py-4 bg-gray-50 border-t">
                    <div class="flex items-center justify-between">
                        <div id="paginationInfo" class="text-sm text-gray-700">
                            Showing 0-0 of 0 results
                        </div>
                        <div id="paginationControls" class="flex space-x-2">
                            <!-- Pagination controls will be added by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Geospatial Map Tab -->
        <div id="map" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Provider Distribution Map</h3>
                    <div class="flex space-x-2">
                        <button id="heatmapBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition">
                            <i class="fas fa-fire mr-2"></i>Heatmap
                        </button>
                        <button id="clustersBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition">
                            <i class="fas fa-layer-group mr-2"></i>Clusters
                        </button>
                    </div>
                </div>
                
                <!-- Map Filters -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <select id="mapCategoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" title="Filter map by category" aria-label="Filter map by category">
                        <option value="">All Categories</option>
                        <option value="residential-cleaning">Residential Cleaning</option>
                        <option value="commercial-janitorial">Commercial Janitorial</option>
                        <option value="carpet-cleaning">Carpet Cleaning</option>
                        <option value="window-cleaning">Window Cleaning</option>
                        <option value="painters">Painters</option>
                        <option value="maintenance">Maintenance Technicians</option>
                        <option value="hvac">HVAC Techs</option>
                        <option value="plumbers">Plumbers</option>
                        <option value="electricians">Electricians</option>
                        <option value="floor-care">Floor Care Specialists</option>
                        <option value="waste-management">Waste Management</option>
                        <option value="pest-control">Pest Control</option>
                        <option value="landscaping">Landscaping/Lawn Care</option>
                        <option value="pressure-washing">Pressure Washing</option>
                        <option value="tub-tile">Tub & Tile Refinishing</option>
                        <option value="construction-cleanup">Construction Cleanup</option>
                        <option value="covid-spray">COVID/Bacterial Spray</option>
                        <option value="car-detailing">Car Detailing</option>
                        <option value="specialty">Specialty Services</option>
                    </select>
                    <select id="mapStateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" title="Filter map by state" aria-label="Filter map by state">
                        <option value="">All States</option>
                        <option value="AL">Alabama</option>
                        <option value="AK">Alaska</option>
                        <option value="AZ">Arizona</option>
                        <option value="AR">Arkansas</option>
                        <option value="CA">California</option>
                        <option value="CO">Colorado</option>
                        <option value="CT">Connecticut</option>
                        <option value="DE">Delaware</option>
                        <option value="FL">Florida</option>
                        <option value="GA">Georgia</option>
                        <option value="HI">Hawaii</option>
                        <option value="ID">Idaho</option>
                        <option value="IL">Illinois</option>
                        <option value="IN">Indiana</option>
                        <option value="IA">Iowa</option>
                        <option value="KS">Kansas</option>
                        <option value="KY">Kentucky</option>
                        <option value="LA">Louisiana</option>
                        <option value="ME">Maine</option>
                        <option value="MD">Maryland</option>
                        <option value="MA">Massachusetts</option>
                        <option value="MI">Michigan</option>
                        <option value="MN">Minnesota</option>
                        <option value="MS">Mississippi</option>
                        <option value="MO">Missouri</option>
                        <option value="MT">Montana</option>
                        <option value="NE">Nebraska</option>
                        <option value="NV">Nevada</option>
                        <option value="NH">New Hampshire</option>
                        <option value="NJ">New Jersey</option>
                        <option value="NM">New Mexico</option>
                        <option value="NY">New York</option>
                        <option value="NC">North Carolina</option>
                        <option value="ND">North Dakota</option>
                        <option value="OH">Ohio</option>
                        <option value="OK">Oklahoma</option>
                        <option value="OR">Oregon</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="RI">Rhode Island</option>
                        <option value="SC">South Carolina</option>
                        <option value="SD">South Dakota</option>
                        <option value="TN">Tennessee</option>
                        <option value="TX">Texas</option>
                        <option value="UT">Utah</option>
                        <option value="VT">Vermont</option>
                        <option value="VA">Virginia</option>
                        <option value="WA">Washington</option>
                        <option value="WV">West Virginia</option>
                        <option value="WI">Wisconsin</option>
                        <option value="WY">Wyoming</option>
                        <option value="DC">District of Columbia</option>
                    </select>
                    <select id="mapTypeFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" title="Filter map by provider type" aria-label="Filter map by provider type">
                        <option value="">All Types</option>
                        <option value="individual">Individual</option>
                        <option value="business">Business Owner</option>
                    </select>
                    <button id="mapSearchBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg focus:ring-2 focus:ring-blue-500 transition">
                        <i class="fas fa-search mr-2"></i>Search Map
                    </button>
                </div>
                
                <!-- Map Container -->
                <div id="providerMap" class="map-container rounded-lg border"></div>
            </div>
        </div>

        <!-- Data Collection Tab -->
        <div id="collection" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Automated Collection -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Automated Data Collection</h3>
                    
                    <div class="space-y-4">
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">Web Scraping Jobs</h4>
                                <span class="text-sm text-green-600">Active</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">Scraping Yelp, BBB, YellowPages, Thomasnet, Manta, ShowMeLocal, SuperPages, Yellowbook, and 20+ more for new providers</p>
                            <div class="flex space-x-2">
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition">Configure</button>
                                <button class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition">Pause</button>
                            </div>
                        </div>
                        
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">API Integration</h4>
                                <span class="text-sm text-blue-600">Running</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">Google Maps API, Yelp API, Yelp Fusion API, and 35+ business directories including WeAndCo, Cylex, Alignable, and more</p>
                            <div class="flex space-x-2">
                                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition">View Logs</button>
                                <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition">Run Now</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Manual Upload -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Manual Data Management</h3>
                    
                    <!-- Export Section -->
                    <div class="mb-4">
                        <h4 class="font-medium mb-2">Export Provider Data</h4>
                        <p class="text-sm text-gray-600 mb-3">Export your service provider database to JSON format for backup or migration</p>
                        
                        <div class="flex space-x-2">
                            <button id="exportProvidersBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm transition">
                                <i class="fas fa-file-export mr-1"></i> Export to JSON
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-6 border-t pt-4">
                        <h4 class="font-medium mb-2">Upload Provider Data</h4>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-4">Drag and drop files here or click to browse</p>
                        <label for="fileUpload" class="sr-only">Upload provider data files</label>
                        <input type="file" id="fileUpload" accept=".csv,.xlsx,.xls,.json" class="hidden" title="Upload provider data files" aria-label="Upload provider data files">
                        <button id="browseFiles" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition">
                            Browse Files
                        </button>
                        <p class="text-sm text-gray-500 mt-2">Supports CSV, Excel, and JSON files</p>
                    </div>
                    
                    <div id="uploadProgress" class="hidden mt-4">
                        <div class="bg-gray-200 rounded-full h-2">
                            <div id="progressBarInner" class="bg-blue-600 h-2 rounded-full progress-bar"></div>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Uploading... 0%</p>
                    </div>
                </div>
            </div>
            
            <!-- Collection Status -->
            <div class="bg-white rounded-xl shadow-md p-6 mt-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Collection Status by Source</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Source</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Last Run</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Records Collected</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Success Rate</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="border-t">
                                <td class="px-4 py-3">Yelp API</td>
                                <td class="px-4 py-3">2 hours ago</td>
                                <td class="px-4 py-3">1,247</td>
                                <td class="px-4 py-3">95.2%</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Active</span></td>
                                <td class="px-4 py-3">
                                    <button class="text-blue-600 hover:text-blue-800">View Details</button>
                                </td>
                            </tr>
                            <tr class="border-t">
                                <td class="px-4 py-3">Google Maps</td>
                                <td class="px-4 py-3">1 hour ago</td>
                                <td class="px-4 py-3">856</td>
                                <td class="px-4 py-3">87.3%</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Active</span></td>
                                <td class="px-4 py-3">
                                    <button class="text-blue-600 hover:text-blue-800">View Details</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


    </main>

    <!-- Modals -->


    <script>
        // Sample data for demonstration
        // Real-time providers data will be loaded from API
        let currentProviders = [];

        // Tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const mobileTabSelector = document.getElementById('mobileTabSelector');

            // Function to switch tabs
            function switchTab(tabName) {
                // Remove active class from all buttons and contents
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent');
                    
                    // Update active button
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active', 'border-blue-500', 'text-blue-600');
                        btn.classList.remove('border-transparent');
                    }
                });
                
                // Hide all tab contents and show selected one
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(tabName).classList.remove('hidden');
                
                // Initialize specific tab functionality
                if (tabName === 'map') {
                    initMap();
                } else if (tabName === 'dashboard') {
                    initCharts();

                }
            }
            
            // Set up desktop tab buttons
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    switchTab(tabName);
                    
                    // Sync mobile dropdown
                    if (mobileTabSelector) {
                        mobileTabSelector.value = tabName;
                    }
                });
            });
            
            // Set up mobile tab selector
            if (mobileTabSelector) {
                mobileTabSelector.addEventListener('change', () => {
                    switchTab(mobileTabSelector.value);
                });
            }

            // Initialize dashboard charts on load
            initCharts();
            
            // Load real data on initialization
            loadDashboardData();
            
            // Initialize search results with real data
            performSearch();
            

            
            // Modal functionality
            initModals();
            
            // File upload
            initFileUpload();
            
            // Event listeners
            initEventListeners();
        });

        // Initialize Charts
        function initCharts() {
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart');
            if (categoryCtx) {
                new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Residential Cleaning', 'HVAC', 'Plumbers', 'Electricians', 'Painters', 'Others'],
                        datasets: [{
                            data: [2847, 2134, 1923, 1567, 1234, 3142],
                            backgroundColor: [
                                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#6B7280'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // State Chart
            const stateCtx = document.getElementById('stateChart');
            if (stateCtx) {
                new Chart(stateCtx, {
                    type: 'bar',
                    data: {
                        labels: ['CA', 'TX', 'NY', 'FL', 'PA', 'IL'],
                        datasets: [{
                            label: 'Providers',
                            data: [2847, 2134, 1923, 1567, 1234, 1098],
                            backgroundColor: '#3B82F6'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // Initialize Map
        function initMap() {
            const mapContainer = document.getElementById('providerMap');
            if (!mapContainer || mapContainer.innerHTML !== '') return;
            
            const map = L.map('providerMap').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // Store the map instance globally
            window.providerMap = map;
            
            // Set up map mode variables
            window.mapMode = 'markers'; // 'markers', 'heatmap', 'clusters'
            window.heatmapLayer = null;
            window.markerClusterGroup = null;
            
            // Add event listeners to map search button
            document.getElementById('mapSearchBtn').addEventListener('click', () => refreshMap(map));
            
            // Add event listeners to heatmap and clusters buttons
            document.getElementById('heatmapBtn').addEventListener('click', () => switchMapMode('heatmap'));
            document.getElementById('clustersBtn').addEventListener('click', () => switchMapMode('clusters'));
            
            // Load and display real provider markers
            loadMapProviders(map);
        }
        
        // Function to refresh the map with current filters
        function refreshMap(map) {
            // Clear existing layers except the base tile layer
            map.eachLayer(layer => {
                if (!(layer instanceof L.TileLayer)) {
                    map.removeLayer(layer);
                }
            });
            
            // Reset any global layers
            if (window.heatmapLayer) {
                map.removeLayer(window.heatmapLayer);
                window.heatmapLayer = null;
            }
            
            if (window.markerClusterGroup) {
                map.removeLayer(window.markerClusterGroup);
                window.markerClusterGroup = null;
            }
            
            // Load with new filters
            loadMapProviders(map);
        }
        
        // Function to switch between map modes (markers, heatmap, clusters)
        function switchMapMode(mode) {
            const map = window.providerMap;
            if (!map) return;
            
            window.mapMode = mode;
            refreshMap(map);
            
            // Update button styles
            document.getElementById('heatmapBtn').className = 
                mode === 'heatmap' ? 'bg-blue-800 text-white px-4 py-2 rounded-lg text-sm transition' : 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition';
            
            document.getElementById('clustersBtn').className = 
                mode === 'clusters' ? 'bg-green-800 text-white px-4 py-2 rounded-lg text-sm transition' : 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition';
        }

        async function loadMapProviders(map) {
            try {
                // Get filter values
                const categoryFilter = document.getElementById('mapCategoryFilter').value;
                const stateFilter = document.getElementById('mapStateFilter').value;
                const typeFilter = document.getElementById('mapTypeFilter').value;
                
                // Build query parameters
                const params = new URLSearchParams();
                params.append('per_page', '100');
                if (categoryFilter) params.append('category', categoryFilter);
                if (stateFilter) params.append('state', stateFilter);
                if (typeFilter) params.append('type', typeFilter);
                
                // Make API call with filters
                const response = await fetch(`/api/providers?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    credentials: 'same-origin' // Include cookies for authentication
                });
                
                if (!response.ok) {
                    let errorMessage = response.statusText;
                    try {
                        // Try to parse error response as JSON
                        const errorData = await response.json();
                        if (errorData && errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        // If not JSON, try to get text
                        try {
                            const errorText = await response.text();
                            if (errorText && errorText.length < 100) {
                                errorMessage = errorText;
                            }
                        } catch (textError) {
                            console.error('Could not parse error response', textError);
                        }
                    }
                    
                    console.error(`Server responded with ${response.status}: ${errorMessage}`);
                    throw new Error(`Failed to fetch map providers: ${errorMessage}`);
                }
                
                const data = await response.json();
                
                // Validate the data structure
                if (!data || !Array.isArray(data.providers)) {
                    throw new Error('Invalid response format from server');
                }
                
                displayProvidersOnMap(map, data.providers);
            } catch (error) {
                console.error('Error loading map providers:', error);
                
                // Show error message on map
                const errorDiv = document.createElement('div');
                errorDiv.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-4 rounded-lg shadow-lg z-1000';
                errorDiv.innerHTML = `<div class="text-red-500 font-semibold"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading map providers</div>
                                      <div class="text-gray-600 text-sm mt-2">${error.message || 'Unknown error'}</div>
                                      <button id="retryMapBtn" class="mt-3 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Retry</button>`;
                
                // Remove existing error message if any
                const existingError = document.querySelector('#providerMap .absolute');
                if (existingError) existingError.remove();
                
                document.getElementById('providerMap').appendChild(errorDiv);
                
                // Add retry button event listener
                document.getElementById('retryMapBtn').addEventListener('click', () => refreshMap(map));
            }
        }

        function displayProvidersOnMap(map, providers) {
            // Update result count for map
            const mapResultCount = document.createElement('div');
            mapResultCount.className = 'absolute top-4 right-4 bg-white px-3 py-2 rounded-lg shadow z-1000';
            mapResultCount.innerHTML = `<strong>${providers.length}</strong> providers found`;
            
            // Remove existing count display if any
            const existingCount = document.querySelector('#providerMap .absolute');
            if (existingCount) existingCount.remove();
            
            document.getElementById('providerMap').appendChild(mapResultCount);
            
            // Filter out providers without coordinates
            const validProviders = providers.filter(provider => provider.latitude && provider.longitude);
            
            if (validProviders.length === 0) return;
            
            // Choose display method based on mode
            switch (window.mapMode) {
                case 'heatmap':
                    displayHeatmap(map, validProviders);
                    break;
                    
                case 'clusters':
                    displayClusters(map, validProviders);
                    break;
                    
                default: // 'markers'
                    displayMarkers(map, validProviders);
            }
        }
        
        // Display individual markers
        function displayMarkers(map, providers) {
            providers.forEach(provider => {
                const marker = L.marker([provider.latitude, provider.longitude]).addTo(map);
                
                const categoryName = provider.category ? provider.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A';
                
                marker.bindPopup(`
                    <div class="p-2">
                        <h4 class="font-semibold">${provider.name}</h4>
                        <p class="text-sm text-gray-600">${provider.city}, ${provider.state}</p>
                        <p class="text-sm">${categoryName}</p>
                        <p class="text-sm">Zipcode: ${formatZipcode(provider.zipcode)}</p>
                        <p class="text-sm text-gray-500">Source: ${provider.source || 'N/A'}</p>
                    </div>
                `);
            });
        }
        
        // Display providers as a heatmap
        function displayHeatmap(map, providers) {
            // Create heatmap data points
            const heatData = providers.map(provider => {
                const intensity = 0.5;  // Fixed intensity since we don't use confidence anymore
                return [provider.latitude, provider.longitude, intensity];
            });
            
            // Create and add heatmap layer
            window.heatmapLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 10,
                gradient: {0.4: 'blue', 0.6: 'lime', 0.8: 'yellow', 1.0: 'red'}
            }).addTo(map);
        }
        
        // Display providers in clusters
        function displayClusters(map, providers) {
            // Create a marker cluster group
            window.markerClusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true
            });
            
            // Add markers to the cluster group
            providers.forEach(provider => {
                const marker = L.marker([provider.latitude, provider.longitude]);
                
                const categoryName = provider.category ? provider.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A';
                
                marker.bindPopup(`
                    <div class="p-2">
                        <h4 class="font-semibold">${provider.name}</h4>
                        <p class="text-sm text-gray-600">${provider.city}, ${provider.state}</p>
                        <p class="text-sm">${categoryName}</p>
                        <p class="text-sm">Zipcode: ${formatZipcode(provider.zipcode)}</p>
                        <p class="text-sm text-gray-500">Source: ${provider.source || 'N/A'}</p>
                    </div>
                `);
                
                window.markerClusterGroup.addLayer(marker);
            });
            
            // Add the cluster group to the map
            map.addLayer(window.markerClusterGroup);
        }

        // Update Search Results
        function updateSearchResults(providers = []) {
            const resultsContainer = document.getElementById('searchResults');
            if (!resultsContainer) return;
            
            // Store current results for view toggle
            window.currentSearchResults = providers;
            
            if (providers.length === 0) {
                resultsContainer.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500 text-base">No providers found</td></tr>';
                return;
            }
            
            resultsContainer.innerHTML = '';
            
            // Update result count
            const resultCount = document.getElementById('resultCount');
            if (resultCount) {
                resultCount.textContent = `Showing ${providers.length} results`;
            }
            
            providers.forEach(provider => {
                const row = document.createElement('tr');
                row.className = 'border-t hover:bg-gray-50';
                
                // Format category name
                const categoryName = provider.category ? provider.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A';
                const location = provider.city && provider.state ? `${provider.city}, ${provider.state}` : (provider.city || provider.state || 'N/A');
                
                row.innerHTML = `
                    <td class="px-2 sm:px-4 py-2 sm:py-3">
                        <input type="checkbox" class="rounded" value="${provider.id}">
                    </td>
                    <td class="px-2 sm:px-4 py-2 sm:py-3" data-label="Name">
                        <div class="font-medium text-sm sm:text-base">${provider.name}</div>
                        <div class="text-xs text-gray-500 sm:hidden">${location}</div>
                        <div class="text-xs text-gray-500 sm:hidden">${provider.phone || 'No phone'}</div>
                        <div class="text-xs sm:hidden">
                            <span class="inline-flex rounded-full bg-${provider.type === 'business' ? 'blue' : 'green'}-100 px-2 py-0.5 text-xs font-semibold text-${provider.type === 'business' ? 'blue' : 'green'}-800">
                                ${provider.type === 'business' ? 'Business' : 'Individual'}
                            </span>
                            <span class="ml-1 bg-gray-100 px-2 py-0.5 rounded-full">${categoryName}</span>
                            <span class="ml-1 bg-gray-100 px-2 py-0.5 rounded-full">ZIP: ${formatZipcode(provider.zipcode)}</span>
                        </div>
                    </td>
                    <td class="hidden sm:table-cell px-2 sm:px-4 py-2 sm:py-3" data-label="Email">${provider.email || 'N/A'}</td>
                    <td class="hidden md:table-cell px-2 sm:px-4 py-2 sm:py-3" data-label="Phone">${provider.phone || 'N/A'}</td>
                    <td class="hidden sm:table-cell px-2 sm:px-4 py-2 sm:py-3" data-label="Location">${location}</td>
                    <td class="hidden lg:table-cell px-2 sm:px-4 py-2 sm:py-3" data-label="Type">
                        <span class="px-2 py-1 bg-${provider.type === 'business' ? 'blue' : 'green'}-100 text-${provider.type === 'business' ? 'blue' : 'green'}-800 rounded-full text-xs">
                            ${provider.type === 'business' ? 'Business' : 'Individual'}
                        </span>
                    </td>
                    <td class="hidden md:table-cell px-2 sm:px-4 py-2 sm:py-3" data-label="Category">${categoryName}</td>
                    <td class="hidden xl:table-cell px-2 sm:px-4 py-2 sm:py-3" data-label="Source">${provider.source || 'N/A'}</td>
                    <td class="hidden lg:table-cell px-2 sm:px-4 py-2 sm:py-3" data-label="Zipcode">
                        <span class="text-sm">${formatZipcode(provider.zipcode)}</span>
                    </td>
                    <td class="px-2 sm:px-4 py-2 sm:py-3" data-label="Actions">
                        <div class="flex space-x-3">
                            <button class="text-blue-600 hover:text-blue-800 text-base sm:text-sm" onclick="editProvider(${provider.id})">
                                <span class="hidden sm:inline">Edit</span>
                                <i class="fas fa-edit sm:hidden"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-800 text-base sm:text-sm" onclick="deleteProvider(${provider.id})">
                                <span class="hidden sm:inline">Delete</span>
                                <i class="fas fa-trash sm:hidden"></i>
                            </button>
                        </div>
                    </td>
                `;
                resultsContainer.appendChild(row);
            });
        }
        
        // Function to update pagination controls
        function updatePagination(data) {
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationControls = document.getElementById('paginationControls');
            
            if (!paginationInfo || !paginationControls) return;
            
            // Handle case where data might be incomplete or undefined
            if (!data || typeof data !== 'object') {
                paginationInfo.textContent = 'No results';
                paginationControls.innerHTML = '';
                return;
            }
            
            const page = data.page || 1;
            const per_page = data.per_page || 20;
            const total = data.total || 0;
            const pages = data.pages || 0;
            
            const start = total > 0 ? (page - 1) * per_page + 1 : 0;
            const end = Math.min(start + per_page - 1, total);
            
            // Update info text
            paginationInfo.textContent = `Showing ${start}-${end} of ${total} results`;
            
            // Clear existing controls
            paginationControls.innerHTML = '';
            
            // Add Previous button
            const prevButton = document.createElement('button');
            prevButton.className = page > 1 
                ? 'px-3 py-1 border border-gray-300 rounded hover:bg-gray-100'
                : 'px-3 py-1 border border-gray-300 rounded text-gray-400 cursor-not-allowed';
            prevButton.textContent = 'Previous';
            prevButton.disabled = page <= 1;
            prevButton.addEventListener('click', () => {
                if (page > 1) performSearch(page - 1);
            });
            paginationControls.appendChild(prevButton);
            
            // Calculate range of page numbers to show
            const maxPageButtons = 3;
            let startPage = Math.max(1, page - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(pages, startPage + maxPageButtons - 1);
            
            // Adjust if we're near the end
            if (endPage - startPage + 1 < maxPageButtons) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }
            
            // Add page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = i === page
                    ? 'px-3 py-1 bg-blue-600 text-white rounded'
                    : 'px-3 py-1 border border-gray-300 rounded hover:bg-gray-100';
                pageButton.textContent = i;
                pageButton.addEventListener('click', () => performSearch(i));
                paginationControls.appendChild(pageButton);
            }
            
            // Add Next button
            const nextButton = document.createElement('button');
            nextButton.className = page < pages
                ? 'px-3 py-1 border border-gray-300 rounded hover:bg-gray-100'
                : 'px-3 py-1 border border-gray-300 rounded text-gray-400 cursor-not-allowed';
            nextButton.textContent = 'Next';
            nextButton.disabled = page >= pages;
            nextButton.addEventListener('click', () => {
                if (page < pages) performSearch(page + 1);
            });
            paginationControls.appendChild(nextButton);
        }

        // Initialize Modals
        function initModals() {
            const addUserBtn = document.getElementById('addUserBtn');
            const addUserModal = document.getElementById('addUserModal');
            const closeModalBtns = document.querySelectorAll('.close-modal');

            if (addUserBtn && addUserModal) {
                addUserBtn.addEventListener('click', () => {
                    addUserModal.classList.remove('hidden');
                });
            }

            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    addUserModal.classList.add('hidden');
                });
            });

            // Close modal on backdrop click
            addUserModal?.addEventListener('click', (e) => {
                if (e.target === addUserModal) {
                    addUserModal.classList.add('hidden');
                }
            });
        }

        // Initialize File Upload
        function initFileUpload() {
            const fileUpload = document.getElementById('fileUpload');
            const browseFiles = document.getElementById('browseFiles');
            const uploadProgress = document.getElementById('uploadProgress');

            if (browseFiles && fileUpload) {
                browseFiles.addEventListener('click', () => {
                    fileUpload.click();
                });

                fileUpload.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        const formData = new FormData();
                        formData.append('file', file);
                        
                        // Display file upload UI
                        uploadProgress.classList.remove('hidden');
                        
                        // Start upload
                        uploadFile(formData);
                    }
                });
            }
        }

        async function uploadFile(formData) {
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = uploadProgress.querySelector('.bg-blue-600');
            const progressText = uploadProgress.querySelector('p');
            
            try {
                // Reset progress bar
                progressBar.style.width = '0%';
                progressText.textContent = 'Starting upload...';
                
                // Start upload
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Upload failed');
                }
                
                // Show success
                progressBar.style.width = '100%';
                progressText.textContent = 'Upload complete!';
                
                // Show notification
                showNotification('File uploaded successfully! Processing data...', 'success');
                
                // Reset file input
                document.getElementById('fileUpload').value = '';
                
                // Hide progress after delay
                setTimeout(() => {
                    uploadProgress.classList.add('hidden');
                    
                    // Refresh stats after successful upload
                    loadDashboardData();
                }, 2000);
                
            } catch (error) {
                console.error('Upload error:', error);
                progressBar.style.width = '100%';
                progressText.textContent = 'Upload failed!';
                progressBar.classList.remove('bg-blue-600');
                progressBar.classList.add('bg-red-600');
                
                // Show error
                showNotification(`Upload failed: ${error.message}`, 'error');
                
                // Reset after delay
                setTimeout(() => {
                    uploadProgress.classList.add('hidden');
                    progressBar.classList.add('bg-blue-600');
                    progressBar.classList.remove('bg-red-600');
                }, 3000);
            }
        }
        
        function simulateUpload() {
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = uploadProgress.querySelector('.bg-blue-600');
            const progressText = uploadProgress.querySelector('p');
            
            uploadProgress.classList.remove('hidden');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(() => {
                        uploadProgress.classList.add('hidden');
                        alert('File uploaded successfully!');
                    }, 500);
                }
                
                progressBar.style.width = progress + '%';
                progressText.textContent = `Uploading... ${Math.round(progress)}%`;
            }, 200);
        }

        // Initialize Event Listeners
        function initEventListeners() {
            // Logout functionality
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn?.addEventListener('click', async function() {
                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        window.location.href = '/login';
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    // Force redirect anyway
                    window.location.href = '/login';
                }
            });
            
            // Search functionality
            const searchBtn = document.getElementById('searchBtn');
            const clearBtn = document.getElementById('clearBtn');
            const searchInput = document.getElementById('searchInput');
            
            searchBtn?.addEventListener('click', performSearch);
            clearBtn?.addEventListener('click', clearSearch);
            searchInput?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });

            // Export functionality
            document.getElementById('exportCsv')?.addEventListener('click', () => exportData('csv'));
            document.getElementById('exportExcel')?.addEventListener('click', () => exportData('excel'));
            
            // Deduplication functionality
            document.getElementById('deduplicateBtn')?.addEventListener('click', deduplicateProviders);

            // Select all checkbox
            document.getElementById('selectAll')?.addEventListener('change', (e) => {
                const checkboxes = document.querySelectorAll('#searchResults input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = e.target.checked);
            });

            // Filter change events
            ['categoryFilter', 'stateFilter', 'typeFilter', 'confidenceFilter'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', performSearch);
            });
        }

        // Store current search parameters globally
        let currentSearchParams = {
            search: '',
            category: '',
            state: '',
            type: '',
            confidence: '',
            page: 1,
            per_page: 20
        };
        
        // Global error handlers
        window.addEventListener('error', (event) => {
            console.error('Global error caught:', event.error || event.message);
            showNotification('An error occurred. Please try again.', 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            showNotification('A network error occurred. Please check your connection.', 'error');
        });
        
        // Function to check network connectivity
        async function checkNetworkConnectivity() {
            try {
                // Try to fetch a small resource to check connectivity
                const response = await fetch('/api/stats', { 
                    method: 'HEAD',
                    cache: 'no-cache',
                    headers: {
                        'pragma': 'no-cache'
                    }
                });
                return response.ok;
            } catch (error) {
                console.error('Network connectivity check failed:', error);
                return false;
            }
        }
        
        async function performSearch(pageNum = 1) {
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const stateFilter = document.getElementById('stateFilter');
            const typeFilter = document.getElementById('typeFilter');
            const confidenceFilter = document.getElementById('confidenceFilter');
            const resultsContainer = document.getElementById('searchResults');
            const resultCount = document.getElementById('resultCount');
            
            // Store current search parameters
            currentSearchParams = {
                search: searchInput?.value || '',
                category: categoryFilter?.value || '',
                state: stateFilter?.value || '',
                type: typeFilter?.value || '',
                confidence: confidenceFilter?.value || '',
                page: pageNum,
                per_page: 20
            };
            
            // Show loading state
            if (resultsContainer) {
                resultsContainer.innerHTML = '<tr><td colspan="8" class="text-center py-8"><i class="fas fa-spinner fa-spin mr-2"></i>Loading providers...</td></tr>';
            }
            
            // Check network connectivity first
            const isOnline = await checkNetworkConnectivity();
            if (!isOnline) {
                if (resultsContainer) {
                    resultsContainer.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-red-500"><i class="fas fa-wifi-slash mr-2"></i>Network connection error. Please check your internet connection and try again.</td></tr>';
                }
                return;
            }
            
            try {
                // Build query parameters
                const params = new URLSearchParams();
                if (currentSearchParams.search) params.append('search', currentSearchParams.search);
                if (currentSearchParams.category) params.append('category', currentSearchParams.category);
                if (currentSearchParams.state) params.append('state', currentSearchParams.state);
                if (currentSearchParams.type) params.append('type', currentSearchParams.type);
                if (currentSearchParams.confidence) params.append('confidence', currentSearchParams.confidence);
                params.append('page', currentSearchParams.page);
                params.append('per_page', currentSearchParams.per_page);
                
                // Make API call
                const response = await fetch(`/api/providers?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    credentials: 'same-origin' // Include cookies for authentication
                });
                
                if (!response.ok) {
                    let errorMessage = response.statusText;
                    try {
                        // Try to parse error response as JSON
                        const errorData = await response.json();
                        if (errorData && errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        // If not JSON, try to get text
                        try {
                            const errorText = await response.text();
                            if (errorText && errorText.length < 100) {
                                errorMessage = errorText;
                            }
                        } catch (textError) {
                            console.error('Could not parse error response', textError);
                        }
                    }
                    
                    console.error(`Server responded with ${response.status}: ${errorMessage}`);
                    throw new Error(`Failed to fetch providers: ${errorMessage}`);
                }
                
                const data = await response.json();
                
                // Validate the data structure
                if (!data || !Array.isArray(data.providers)) {
                    throw new Error('Invalid response format from server');
                }
                
                currentProviders = data.providers; // Store for other functions
                updateSearchResults(data.providers);
                updatePagination(data);
                
                // Update result count
                if (resultCount) {
                    resultCount.textContent = `Showing ${data.providers.length} of ${data.total} results`;
                }
                
            } catch (error) {
                console.error('Error fetching providers:', error);
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-8">
                                <div class="flex flex-col items-center">
                                    <div class="text-red-500 mb-2">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>Error loading providers: ${error.message || 'Unknown error'}
                                    </div>
                                    <button id="retrySearchBtn" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                                        <i class="fas fa-redo mr-2"></i>Retry
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    
                    // Add event listener to retry button
                    setTimeout(() => {
                        document.getElementById('retrySearchBtn')?.addEventListener('click', () => performSearch(currentSearchParams.page));
                    }, 100);
                }
                
                // Update pagination to show no results
                updatePagination({
                    page: 1,
                    per_page: 20,
                    total: 0,
                    pages: 0,
                    providers: []
                });
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            ['categoryFilter', 'stateFilter', 'typeFilter', 'confidenceFilter'].forEach(id => {
                document.getElementById(id).value = '';
            });
            performSearch();
        }

        async function exportData(format) {
            try {
                // Get current filter values
                const searchInput = document.getElementById('searchInput');
                const categoryFilter = document.getElementById('categoryFilter');
                const stateFilter = document.getElementById('stateFilter');
                const typeFilter = document.getElementById('typeFilter');
                const confidenceFilter = document.getElementById('confidenceFilter');
                
                // Get selected provider IDs
                const selectedCheckboxes = document.querySelectorAll('#searchResults input[type="checkbox"]:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value).filter(id => id);
                
                // Build export data
                const exportData = {
                    format: format,
                    filters: {
                        search: searchInput?.value || '',
                        category: categoryFilter?.value || '',
                        state: stateFilter?.value || '',
                        type: typeFilter?.value || '',
                        confidence: confidenceFilter?.value || ''
                    },
                    selectedIds: selectedIds
                };
                
                // Show loading
                const exportBtn = event.target;
                const originalText = exportBtn.textContent;
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
                
                // Make API call
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(exportData)
                });
                
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                // Get the file blob and download it
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `providers_export_${new Date().toISOString().slice(0,10)}.${format === 'csv' ? 'csv' : 'xlsx'}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success message
                showNotification('Export completed successfully!', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export failed. Please try again.', 'error');
            } finally {
                // Reset button
                const exportBtn = event.target;
                exportBtn.disabled = false;
                exportBtn.textContent = originalText;
            }
        }

        // Real-time updates simulation
        setInterval(() => {
            const activityTable = document.getElementById('activityTable');
            if (activityTable && Math.random() > 0.7) {
                const sources = [
                    // API-based sources
                    'Yelp API', 'Google Maps API', 'Yelp Fusion API',
                    // Scrapers
                    'BBB Scraper', 'YellowPages Scraper', 'Thomasnet', 'D&B Business Directory', 'Manta', 'Foursquare Scraper', 'Hotfrog Scraper',
                    // Business Directories
                    'CityLocal Pro', 'USA Company Directory', 'AllBusiness Directory', 'US Chamber of Commerce Directory', 'Citysearch', 'MerchantCircle',
                    // New Business Directories
                    'ShowMeLocal', 'WeAndCo', 'Pocket Insights', 'eLocal', 'Brownbook', 'Cylex USA', 'Local.com', 
                    'SuperPages', 'CitySquares', 'EZlocal', '2FindLocal', 'BOTW', 'Yellowbook', 'DexKnows', 'Alignable'
                ];
                const categories = ['Residential Cleaning', 'HVAC', 'Plumbers', 'Electricians'];
                const statuses = ['Success', 'Processing', 'Failed'];
                
                const newRow = document.createElement('tr');
                newRow.className = 'border-t';
                newRow.innerHTML = `
                    <td class="px-4 py-3">${sources[Math.floor(Math.random() * sources.length)]}</td>
                    <td class="px-4 py-3">${categories[Math.floor(Math.random() * categories.length)]}</td>
                    <td class="px-4 py-3">${Math.floor(Math.random() * 500) + 50}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">
                            ${statuses[Math.floor(Math.random() * statuses.length)]}
                        </span>
                    </td>
                    <td class="px-4 py-3">Just now</td>
                `;
                
                if (activityTable.children.length >= 5) {
                    activityTable.removeChild(activityTable.lastChild);
                }
                activityTable.insertBefore(newRow, activityTable.firstChild);
            }
        }, 10000);

        // Helper Functions
        /**
         * Format zipcode to exactly 5 digits
         * This fixes the issue where some zipcodes were showing as 6 digits
         * - Truncates zipcodes longer than 5 digits
         * - Pads zipcodes shorter than 5 digits with leading zeros
         * - Returns 'N/A' for null/undefined values
         */
        function formatZipcode(zipcode) {
            if (!zipcode) return 'N/A';
            
            // Convert to string and trim any spaces
            let zip = String(zipcode).trim();
            
            // If the zipcode is longer than 5 digits, truncate to 5
            if (zip.length > 5) {
                return zip.substring(0, 5);
            }
            
            // If it's shorter than 5 digits, pad with zeros
            while (zip.length < 5) {
                zip = '0' + zip;
            }
            
            return zip;
        }
        
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 max-w-[90vw] sm:max-w-md ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                        <span class="text-sm sm:text-base">${message}</span>
                    </div>
                    <button class="ml-2 text-white hover:text-gray-200" onclick="this.parentNode.parentNode.parentNode.removeChild(this.parentNode.parentNode)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after specified duration
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }
            }, duration);
        }
        
        // Helper function to show modal dialogs for developer features
        function showModal(title, content) {
            // Create modal container
            const modalContainer = document.createElement('div');
            modalContainer.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white rounded-xl p-6 w-full max-w-2xl';
            modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">${title}</h3>
                    <button class="close-modal text-gray-500 hover:text-gray-700" title="Close modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div>${content}</div>
            `;
            
            modalContainer.appendChild(modalContent);
            document.body.appendChild(modalContainer);
            
            // Add close button functionality
            const closeButton = modalContent.querySelector('.close-modal');
            closeButton.addEventListener('click', () => {
                modalContainer.remove();
            });
            
            // Close on click outside modal
            modalContainer.addEventListener('click', (e) => {
                if (e.target === modalContainer) {
                    modalContainer.remove();
                }
            });
        }

        async function loadDashboardData() {
            try {
                // Load dashboard statistics
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateDashboardStats(stats);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateDashboardStats(stats) {
            // Update stat cards if they exist
            const totalProvidersEl = document.querySelector('[data-stat="total-providers"]');
            const individualsEl = document.querySelector('[data-stat="individuals"]');
            const businessesEl = document.querySelector('[data-stat="businesses"]');
            const statesEl = document.querySelector('[data-stat="states"]');
            
            if (totalProvidersEl && stats.totalProviders) {
                totalProvidersEl.textContent = stats.totalProviders.toLocaleString();
            }
            if (individualsEl && stats.individuals) {
                individualsEl.textContent = stats.individuals.toLocaleString();
            }
            if (businessesEl && stats.businesses) {
                businessesEl.textContent = stats.businesses.toLocaleString();
            }
            if (statesEl && stats.statesCovered) {
                statesEl.textContent = stats.statesCovered;
            }
        }

        function editProvider(providerId) {
            showNotification('Edit functionality coming soon!', 'info');
        }

        function deleteProvider(providerId) {
            if (confirm('Are you sure you want to delete this provider?')) {
                showNotification('Delete functionality coming soon!', 'info');
            }
        }

        async function deduplicateProviders() {
            if (!confirm('This will analyze all providers and remove ONLY exact duplicates (100% similar). Providers with minor differences will be kept. Continue?')) {
                return;
            }

            const deduplicateBtn = document.getElementById('deduplicateBtn');
            const originalContent = deduplicateBtn.innerHTML;
            
            try {
                // Show loading state
                deduplicateBtn.disabled = true;
                deduplicateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...';
                
                // Make API call
                const response = await fetch('/api/deduplicate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Deduplication failed');
                }
                
                const data = await response.json();
                
                // Show success message
                showNotification(data.message, 'success');
                
                // Refresh the search results
                performSearch();
                
                // Refresh dashboard stats
                loadDashboardData();
                
            } catch (error) {
                console.error('Deduplication error:', error);
                showNotification('Deduplication failed. Please try again.', 'error');
            } finally {
                // Reset button
                deduplicateBtn.disabled = false;
                deduplicateBtn.innerHTML = originalContent;
            }
        }
        
        // Database check and repair functionality

        

        

        

        

        

        

        
        // Add export functionality
        const exportProvidersBtn = document.getElementById('exportProvidersBtn');
        if (exportProvidersBtn) {
            exportProvidersBtn.addEventListener('click', handleExportProviders);
        }
        
        async function handleExportProviders() {
            try {
                // Show loading state
                const originalContent = exportProvidersBtn.innerHTML;
                exportProvidersBtn.disabled = true;
                exportProvidersBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exporting...';
                
                // Get any active filters from the search tab
                const category = document.getElementById('searchCategory')?.value || '';
                const state = document.getElementById('searchState')?.value || '';
                const source = document.getElementById('searchSource')?.value || '';
                
                // Create the export URL with optional filters
                let exportUrl = '/api/export/providers?';
                const params = [];
                
                if (category) params.push(`category=${encodeURIComponent(category)}`);
                if (state) params.push(`state=${encodeURIComponent(state)}`);
                if (source) params.push(`source=${encodeURIComponent(source)}`);
                
                exportUrl += params.join('&');
                
                // Trigger file download
                window.location.href = exportUrl;
                
                // Show success message
                showNotification('Export started. Your download will begin shortly.', 'success');
                
                // Reset button after a delay
                setTimeout(() => {
                    exportProvidersBtn.disabled = false;
                    exportProvidersBtn.innerHTML = originalContent;
                }, 2000);
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Export failed. Please try again.', 'error');
                exportProvidersBtn.disabled = false;
                exportProvidersBtn.innerHTML = '<i class="fas fa-file-export mr-1"></i> Export to JSON';
            }
        }

        // Back to top button functionality
        const backToTopBtn = document.getElementById('backToTopBtn');
        
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) {
                backToTopBtn.classList.remove('hidden');
            } else {
                backToTopBtn.classList.add('hidden');
            }
        });
        
        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
        
        // Show hint for mobile users about scrolling table
        if (window.innerWidth < 640) {
            setTimeout(() => {
                showNotification('Tip: Swipe horizontally to see more data or tap the view button to switch to card view', 'info', 7000);
            }, 1000);
        }
        
        // Mobile view toggle functionality
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const viewIcon = document.getElementById('viewIcon');
        let isCardView = false;
        
        if (toggleViewBtn) {
            toggleViewBtn.addEventListener('click', () => {
                isCardView = !isCardView;
                const resultsContainer = document.getElementById('searchResults');
                const resultsTable = document.querySelector('.search-results-table');
                
                if (isCardView) {
                    // Switch to card view
                    viewIcon.className = 'fas fa-th-list';
                    resultsTable.classList.add('mobile-card-view');
                    showNotification('Switched to card view for better mobile visibility', 'info');
                } else {
                    // Switch to table view
                    viewIcon.className = 'fas fa-table';
                    resultsTable.classList.remove('mobile-card-view');
                    showNotification('Switched to table view', 'info');
                }
                
                // Re-render current results with the new view
                if (window.currentSearchResults && window.currentSearchResults.length > 0) {
                    updateSearchResults(window.currentSearchResults);
                }
            });
        }

        // Check for mobile devices and adjust UI if needed
        if (window.innerWidth < 640) {
            // Any mobile-specific initial setup can go here
            document.querySelectorAll('.sm-stack').forEach(el => {
                el.classList.add('flex', 'flex-col');
            });
            
            // Show hint for mobile users about table navigation
            setTimeout(() => {
                showNotification('Tip: Swipe horizontally to see more data or tap the view button to switch to card view', 'info', 7000);
            }, 1000);
        }
    </script>

    <!-- Mobile View Toggle -->
    <div class="fixed bottom-20 right-6 z-50 sm:hidden">
        <button id="toggleViewBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-all" aria-label="Toggle view">
            <i class="fas fa-table" id="viewIcon"></i>
        </button>
    </div>
    
    <!-- Back to Top Button -->
    <button id="backToTopBtn" class="hidden fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-all z-50" aria-label="Back to top">
        <i class="fas fa-arrow-up"></i>
    </button>
</body>
</html>